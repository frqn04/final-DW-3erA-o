"""
Vistas para la app users.

Este m√≥dulo contiene las vistas para funcionalidades espec√≠ficas de usuarios,
incluyendo login personalizado y cambio de contrase√±a obligatorio.
"""

from django.shortcuts import render, redirect
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.urls import reverse
from django.views.decorators.csrf import csrf_protect
from django.views.decorators.cache import never_cache
from django.http import HttpResponseRedirect

from .forms import LoginForm, CustomPasswordChangeForm
from .auth_backends import EmailDNIBackend


@csrf_protect
@never_cache
def login_view(request):
    """
    Vista de login personalizada usando EmailDNIBackend.
    
    Esta vista maneja el proceso de autenticaci√≥n usando email, DNI y contrase√±a.
    Utiliza el backend personalizado EmailDNIBackend para mayor seguridad.
    
    Args:
        request: El objeto HttpRequest
        
    Returns:
        HttpResponse: Renderiza el template de login o redirige si es exitoso
    """
    
    # Si el usuario ya est√° autenticado, redirigir a home
    if request.user.is_authenticated:
        return redirect('core:home')
    
    if request.method == 'POST':
        form = LoginForm(request.POST)
        
        if form.is_valid():
            # Obtener datos limpios del formulario
            email = form.cleaned_data['email']
            dni = form.cleaned_data['dni']
            password = form.cleaned_data['password']
            remember_me = form.cleaned_data.get('remember_me', False)
            
            # Intentar autenticaci√≥n usando el backend personalizado
            user = authenticate(
                request,
                username=email,  # EmailDNIBackend usa 'username' para el email
                password=password,
                dni=dni
            )
            
            if user is not None:
                # Autenticaci√≥n exitosa
                login(request, user)
                
                # Configurar duraci√≥n de sesi√≥n
                if remember_me:
                    # Mantener sesi√≥n por 30 d√≠as
                    request.session.set_expiry(30 * 24 * 60 * 60)
                else:
                    # Sesi√≥n expira al cerrar el navegador
                    request.session.set_expiry(0)
                
                # Limpiar flag de mensaje de cambio de contrase√±a
                request.session.pop('password_change_message_shown', None)
                
                # Mensaje de bienvenida
                messages.success(
                    request,
                    f'¬°Bienvenido {user.get_full_name()}! Has iniciado sesi√≥n correctamente.'
                )
                
                # Redirigir a la p√°gina solicitada o a home por defecto
                next_url = request.GET.get('next') or reverse('core:home')
                return HttpResponseRedirect(next_url)
            
            else:
                # Autenticaci√≥n fallida
                messages.error(
                    request,
                    '‚ùå Credenciales incorrectas. Verifica tu email, DNI y contrase√±a.'
                )
                
                # Por seguridad, no especificar qu√© campo espec√≠fico est√° mal
                # Esto previene ataques de enumeraci√≥n de usuarios
        
        else:
            # Formulario inv√°lido
            messages.error(
                request,
                '‚ùå Por favor corrige los errores en el formulario.'
            )
    
    else:
        # Petici√≥n GET - mostrar formulario vac√≠o
        form = LoginForm()
    
    context = {
        'form': form,
        'title': 'Iniciar Sesi√≥n - Sistema Escolar',
    }
    
    return render(request, 'users/login.html', context)


@login_required
@csrf_protect
def change_password_first_login(request):
    """
    Vista para cambio obligatorio de contrase√±a en el primer login.
    
    Esta vista se utiliza cuando un usuario tiene must_change_password=True.
    Despu√©s del cambio exitoso, actualiza el flag a False y redirige a home.
    
    Args:
        request: El objeto HttpRequest
        
    Returns:
        HttpResponse: Renderiza el template de cambio o redirige si es exitoso
    """
    
    # Verificar si el usuario realmente necesita cambiar la contrase√±a
    if not request.user.must_change_password:
        messages.info(
            request,
            'Ya has actualizado tu contrase√±a. No es necesario cambiarla nuevamente.'
        )
        return redirect('core:home')
    
    if request.method == 'POST':
        form = CustomPasswordChangeForm(user=request.user, data=request.POST)
        
        if form.is_valid():
            # Guardar la nueva contrase√±a
            user = form.save()
            
            # IMPORTANTE: Actualizar el flag must_change_password
            user.must_change_password = False
            user.save(update_fields=['must_change_password'])
            
            # Limpiar flag de mensaje de cambio de contrase√±a de la sesi√≥n
            request.session.pop('password_change_message_shown', None)
            
            # Mensaje de √©xito
            messages.success(
                request,
                '‚úÖ ¬°Contrase√±a actualizada exitosamente! '
                'Ahora puedes acceder a todas las funcionalidades del sistema.'
            )
            
            # Redirigir a home
            return redirect('core:home')
        
        else:
            # Formulario inv√°lido - mostrar errores
            messages.error(
                request,
                '‚ùå Hubo errores al cambiar tu contrase√±a. '
                'Por favor revisa los campos marcados.'
            )
    
    else:
        # Petici√≥n GET - mostrar formulario vac√≠o
        form = CustomPasswordChangeForm(user=request.user)
    
    context = {
        'form': form,
        'title': 'Cambiar Contrase√±a - Primer Acceso',
        'user': request.user,
    }
    
    return render(request, 'users/change_password_first_login.html', context)


@login_required
def logout_view(request):
    """
    Vista para cerrar sesi√≥n.
    
    Args:
        request: El objeto HttpRequest
        
    Returns:
        HttpResponse: Redirige al login con mensaje de confirmaci√≥n
    """
    user_name = request.user.get_full_name()
    logout(request)
    
    messages.success(
        request,
        f'üëã ¬°Hasta luego {user_name}! Has cerrado sesi√≥n correctamente.'
    )
    
    return redirect('users:login')
